---
description: Standards for the AI agent system (OpenClaw-inspired patterns)
globs: src/agents/**/*.ts
alwaysApply: false
---

# Agent System Standards

## Local Reference

Always consult these before writing agent system code:
- `docs/openclaw-patterns.md` — extracted patterns with our adaptations
- `docs/openclaw-reference/src/agents/` — OpenClaw agent runner source
- `docs/openclaw-reference/src/process/command-queue.ts` — lane queue reference
- `docs/openclaw-reference/src/channels/plugins/types.ts` — channel adapter pattern
- `docs/openclaw-reference/skills/` — skill implementation examples

**IMPORTANT**: We extract patterns from OpenClaw — we do NOT import it as a dependency.

## Architecture Overview

The agent system extracts six patterns from OpenClaw:
1. **Lane Queue** — per-agent async queue ensuring serial execution
2. **Agent Runner** — core LLM loop (prompt → call → tool execution → response)
3. **Skill System** — OpenAI-compatible tool definitions for game commands (works with Kimi K2/K2.5)
4. **Channel Adapter** — bridges RPGJS events to agent runner
5. **Memory System** — conversation buffer + JSON persistence
6. **System Prompt Builder** — modular prompt assembly per NPC

## AgentRunner

- One `AgentRunner` per NPC character
- Manages: personality, available skills, memory, LLM client
- System prompt sections: identity → world context → skills → memory → rules → current state
- Tool use / function calling: parse tool calls, execute skills, return results
- Rate limiting: prevent agent from spamming LLM calls
- Configurable model per call type:
  - Idle behavior → Kimi K2 (`kimi-k2-0905-chat`)
  - Conversation → Kimi K2.5 (`kimi-k2.5`)
- Execution feedback: if a skill fails, error fed back to LLM for re-planning

**OpenClaw reference**: `docs/openclaw-reference/src/agents/pi-embedded-runner/run.ts`

## Skill Definitions

- MVP: Use OpenAI-compatible `tools` parameter (function calling via Kimi K2/K2.5)
- Each skill maps to one RPGJS game action
- Skills receive a `GameContext` with access to the NPC's RpgEvent instance
- Skills validate parameters before executing
- Skills return a result string for the LLM to see what happened
- Handle errors gracefully — return error message, don't throw

```ts
// Skill definition pattern
const moveSkill: IAgentSkill = {
    name: 'move',
    description: 'Move to a direction',
    parameters: {
        direction: { type: 'string', enum: ['north', 'south', 'east', 'west'] },
        steps: { type: 'number', description: 'Number of tiles to move' }
    },
    execute: async (params, context) => {
        // Call RPGJS movement API via context.npcEvent
        return { success: true, message: 'Moved 3 tiles east' }
    }
}
```

**OpenClaw reference**: `docs/openclaw-reference/src/agents/pi-tools.ts`

## Perception Engine

- Output: structured JSON + one-line narrative summary
- Target: < 300 tokens per snapshot
- Include: position, map name, nearby entities (capped at 5 closest), self state
- Do NOT include raw pixel coordinates — use tile-based or relative positions
- Generate the `summary` field as a one-line narrative anchor

## Memory System

- **Short-term**: Last N conversation exchanges (in-memory array)
- **Token budget**: Trim oldest memories when context exceeds budget
- **Per-agent isolation**: Each agent has its own memory instance
- **MVP persistence**: JSON files per agent, reload on startup
- **Compaction**: When context overflows, summarize oldest messages (OpenClaw pattern)
- **Post-MVP**: Hybrid vector + text search (OpenClaw `memory-search.ts` pattern)

**OpenClaw reference**:
- `docs/openclaw-reference/src/agents/memory-search.ts`
- `docs/openclaw-reference/extensions/memory-core/index.ts`

## Lane Queue

- Simple async mutex/queue per agent ID (~50 lines of TypeScript)
- Default serial execution — one LLM call at a time per agent
- Queue incoming events when agent is busy
- Drop or merge stale events if queue grows too long
- Each NPC = one lane. Multiple NPCs run in parallel.

**OpenClaw reference**: `docs/openclaw-reference/src/process/command-queue.ts`

## LLM Integration

- Use `openai` SDK pointed at Moonshot API (`https://api.moonshot.ai/v1`)
- Primary models: Kimi K2 (idle) and Kimi K2.5 (conversation)
- Automatic context caching: 75% savings on repeated context (no config needed)
- Environment variables: `MOONSHOT_API_KEY` (or `KIMI_API_KEY` as fallback)
- Future: may add Anthropic/Google providers via Vercel AI SDK (`ai` package)
- Handle API errors gracefully — NPC says something generic, retries later
- Error classification (from OpenClaw):
  - `context_overflow` → compact/summarize old messages
  - `rate_limit` → reduce idle tick frequency temporarily
  - `timeout` → NPC shows "Hmm..." + retry once
  - `auth_error` → disable agent, log error

**OpenClaw reference**: `docs/openclaw-reference/src/agents/failover-error.ts`

## Bridge Layer (GameChannelAdapter)

- One adapter per NPC, bound to a specific RpgEvent instance
- Subscribes to RPGJS hooks: `onAction`, `onDetectInShape`, `onDetectOutShape`
- Idle tick via `setInterval` (~15 seconds), NOT via RPGJS `onStep`
- Converts RPGJS events → `AgentEvent` → enters lane queue
- Routes agent responses → skill execution → RPGJS API calls
- "Thinking" indicator: NPC faces player + shows "..." while LLM processes

**OpenClaw reference**: `docs/openclaw-reference/src/channels/plugins/types.ts`

## Agent Configuration (YAML)

Agent personalities are declarative YAML files — never hardcode personalities:

```yaml
# src/config/agents/elder-theron.yaml
id: elder-theron
name: Elder Theron
graphic: npc-elder
personality: |
  You are Elder Theron, the wise village elder...
model:
  idle: kimi-k2-0905-chat
  conversation: kimi-k2.5
skills: [say, move, look, emote, wait]
spawn:
  map: medieval
  x: 300
  y: 200
behavior:
  idle_interval: 15000
  patrol_radius: 3
```

**OpenClaw reference**: `docs/openclaw-reference/src/config/types.agents.ts`

## Error Handling (Hard Requirement)

**Agent errors must NEVER crash the game server.**

- Wrap ALL agent operations in try/catch
- On failure: fall back to canned behavior (random walk, generic greeting)
- Log with prefixes: `[AgentManager]`, `[Agent:ElderTheron]`, `[Bridge]`, `[LaneQueue]`
- Never let an unhandled Promise rejection escape to RPGJS
